{
  "hash": "278cf2381726442e7bf26a1117647ac3",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Almost orthogonal vectors in high dimensionalities\"\n# description: \"Post description\"\nauthor: \"Inar Timiryasov\"\ndate: \"2024-01-08\"\ndraft: true\n<!-- categories:\n  - LLM -->\nformat:\n  html:\n    code-fold: true\n---\n\n# How many almost orthogonal vectors can we have in high dimensions?\n\n## TODO\n- Intro about vectors in high dimensions and how can we store information\n- Use mamba and vect2text as motivation\n- write the usual proof of orthogonality based on normal distribution\n\nIn this post we will discuss the following question: how many approximately orthogonal vectors can we have in high dimensions? \n<!-- This question is motivated by the recent paper [Linformer: Self-Attention with Linear Complexity](https://arxiv.org/abs/2006.04768) by Wang et al. In this paper the authors propose a new self-attention mechanism that is linear in the sequence length. The key idea is to approximate the self-attention matrix by a low-rank matrix. The authors show that the approximation error is small if the input sequence is approximately orthogonal. This raises the question: how many approximately orthogonal vectors can we have in high dimensions? -->\n\n<!-- High-dimensional spaces are weird. For example, the volume of a sphere in high dimensions is concentrated near the equator. This means that there is a lot of room for almost orthogonal vectors. In fact, there are exponentially many such vectors. This is a rather surprising result that was first obtained by Shannon in 1959. In this post we will discuss the result and its proof. -->\n\n<!-- High-dimensional spaces can accommodate counter-intuitively many distinguishable vectors. -->\n\n<!-- Dot product is motivated by attention mechanism. -->\n\n\n\n## Why even ask this question?\nSuppose we have vectors in $\\mathbb{R}^d$. These vectors could be, e.g. the activations in the residual stream of a transformer, or a state space in the state space models like [mamba](https://arxiv.org/abs/2312.00752\n). By definition, there will be $d$ orthogonal vectors. By orthogonal we mean that $ v_i \\cdot v_j = 0$ for $i \\neq j$. But what if we require that $v_i \\cdot v_j \\leq \\epsilon $ for $i \\neq j$? How many such vectors can we have? Quite surprisingly, there are many such vectors. In fact, there are exponentially many such vectors.\n\nOne cue to suspect that it might be true is the so-called [concentration of measure](https://en.wikipedia.org/wiki/Concentration_of_measure) phenomenon, which says that most of the mass of a sphere in $\\mathbb{R}^d$ is close to the equator. Imagine a sphere and one vector $v_1$ pointing to the North. Vectors that are almost orthogonal to $v_1$ will be close to the equator. And since most of the mass of the sphere is close to the equator, there could be room for many such vectors. But how many exactly?\n\n## Spherical caps\nA spherical cap is a portion of a sphere that is cut off by a plane. \n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom mpl_toolkits.mplot3d import Axes3D\n\ndef plot_sphere_with_uniform_color(radius=1, z_max=np.sqrt(2)/2):\n    \"\"\"\n    Plots a sphere with a uniformly colored spherical cap using Matplotlib.\n    Displays the Cartesian coordinate axes and the opening angle theta.\n\n    Parameters:\n    radius (float): Radius of the sphere.\n    z_max (float): Maximum z-coordinate for the cap, scaled between 0 and 1. \n\n    Returns:\n    Matplotlib figure\n    \"\"\"\n\n    # Define the azimuthal angle phi and theta\n    phi = np.linspace(0, 2 * np.pi, 100)\n    theta = np.linspace(0, np.pi, 100)\n    phi, theta = np.meshgrid(phi, theta)\n\n    # Parametric equations for the sphere\n    x = radius * np.sin(theta) * np.cos(phi)\n    y = radius * np.sin(theta) * np.sin(phi)\n    z = radius * np.cos(theta)\n\n    # Create a 3D plot\n    fig = plt.figure(figsize=(8, 6))\n    ax = fig.add_subplot(111, projection='3d')\n\n    # Plot the sphere\n    ax.plot_surface(x, y, z, color='blue', alpha=0.2)\n\n    # Calculate the angle for the cap based on z_max\n    theta_max = np.arccos(z_max)\n    cap_theta = np.linspace(0, theta_max, 50)\n    cap_phi, cap_theta = np.meshgrid(phi[0], cap_theta)\n\n    # Parametric equations for the cap\n    cap_x = radius * np.sin(cap_theta) * np.cos(cap_phi)\n    cap_y = radius * np.sin(cap_theta) * np.sin(cap_phi)\n    cap_z = radius * np.cos(cap_theta)\n    ax.plot_surface(cap_x, cap_y, cap_z, color='orange', alpha=1.0)\n\n    # Add Cartesian coordinate axes with labels\n    axis_length = radius * 1.4\n    ax.quiver(0, 0, 0, axis_length, 0, 0, color='black', arrow_length_ratio=0.05)\n    ax.quiver(0, 0, 0, 0, axis_length, 0, color='black', arrow_length_ratio=0.05)\n    ax.quiver(0, 0, 0, 0, 0, axis_length, color='black', arrow_length_ratio=0.05)\n    ax.text(axis_length*1.15, 0, 0, \"X\", color='black')\n    ax.text(0, axis_length*1.1, 0, \"Y\", color='black')\n    ax.text(0, 0, axis_length*1.1, \"Z\", color='black')\n\n    # Display the opening angle theta\n    edge_x = radius * np.sin(theta_max)\n    edge_z = radius * np.cos(theta_max)\n    ax.plot([0, edge_x], [0, 0], [0, edge_z], color='orange', linestyle='dashed')\n    ax.text(edge_x / 2, 0, edge_z / 2+0.05, r'$\\theta$', fontsize=16, color='orange')\n\n    # Setting the aspect ratio\n    ax.set_box_aspect([1,1,1])  # Aspect ratio is 1:1:1\n    ax.view_init(elev=20, azim=40)\n\n    ax.set_xticks([])\n    ax.set_yticks([])\n    ax.set_zticks([])\n\n    return fig\n\n# Plot the sphere with the cap\nfig = plot_sphere_with_uniform_color()\nplt.show()\n\n```\n\n::: {.cell-output .cell-output-display}\n![A sperical cap.](index_files/figure-pdf/sphere-output-1.pdf){#sphere fig-pos='H'}\n:::\n:::\n\n\nAn area of a spherical cap in 3D is given by\n$$A = 2 \\pi r^2 (1-\\cos\\theta)$$\nwhere $r$ is the radius of the sphere and $\\theta$ is the polar angle.\n\nIf we have two vectors with their own spherical caps with opening angles \n\n\n\nWe can now imagine that almost orthogonal vectors all define their own spherical caps with $\\theta = \\pi/4 - \\epsilon/2$.\nHow many such caps can we place on a sphere in d dimensions?\n\n\nA very simple estimate could be obtained as follows. Lets compute the area of a spherical cap with the opening angle $\\alpha$. This can be done relatively straightforwardly by introducing spherical coordinates in $D$ dimensions (see [wiki](https://en.wikipedia.org/wiki/N-sphere)). \nThe ratio of the area of a spherical cap to the area of the whole sphere.\n$$r_D(\\alpha) = \\frac{\\int_0^\\alpha \\sin^{D-2}(\\theta) d\\theta}{2 \\int_0^{\\pi/2} \\sin^{D-2}(\\theta) d\\theta}.$$\n\nBut this is not the whole story. High dimensions are weird, the area of \"empty spaces\" between the caps also grows quickly (a nice vide by 3Blue1Brown on a related topic [here](https://www.youtube.com/watch?v=zwAD6dRSVyI)). So we need to take this into account. \n\n## Spherical codes\nIt turns out that this precise question has been asked by \nShannon himself in 1959. He considered code words $w_m = (s_1, s_2, \\ldots, s_n)$ where $s_i$ are real numbers and the power of code words is the same so $s_i$ lie on a sphere. He asked how many such code words can we have given a certain error tolerance.\nIn other words, he asked how many points can we place on a sphere such that $w_m \\cdot w_k \\leq \\epsilon$ for $m \\neq k$. \nShannon's [paper](https://ia902905.us.archive.org/18/items/bstj38-3-611/bstj38-3-611.pdf) \"Probability of Error for Optimal Codes in a Gaussian Channel\" is a feast of analysis and geometrical reasoning in high dimensions, but, as he puts it himself, \"It might be said that the algebra involved is in several places unusually tedious\". I don't show the results here since it requires introducing literally one page of definitions.\n\nShannon's bound was further improved by Kabatiansky and Levenshtein in 1978 [paper](https://www.mathnet.ru/links/9bcb05981fd711e6ffcc3a4fe45bf559/ppi1518.pdf). Their paper is also super nice to read (especially if one knows Russian) and the main result can be state in a rather accessible form.\n\nThe number of vectors with the angle between them exceeding $\\theta$ is bounded by, for large $n$,\n$$\nM(n, \\theta) \\leq 2^{n \\,C(\\theta)}, \n$$\nwhere\n$$\nC(\\theta) =  \\frac{1+\\sin \\theta}{2\\sin\\theta}\\log \\frac{1+\\sin\\theta}{2\\sin\\theta} - \\frac{1-\\sin \\theta}{2\\sin\\theta}\\log \\frac{1-\n\\sin\\theta}{2\\sin\\theta}.\n$$\n\n\n\n![orthogonal-vectors](D-dim.png)\n\n# References\n\n- Terrence Tao presents a rather straightforward derivation of a slightly weaker bound  where $\\epsilon = 1/\\sqrt{n}$ [https://terrytao.wordpress.com](https://terrytao.wordpress.com/2013/07/18/a-cheap-version-of-the-kabatjanskii-levenstein-bound-for-almost-orthogonal-vectors/)\nPerhaps he was interested in compressed sensing at that time.\n\n- [Kabatiansky,  Levenshtein](https://www.mathnet.ru/links/9bcb05981fd711e6ffcc3a4fe45bf559/ppi1518.pdf\n\n- [Blogpost by Le Scao on Johnson-Lindenstrauss lemma](https://tevenlescao.github.io/blog/fastpages/jupyter/2020/06/18/JL-Lemma-+-Linformer.html\n\n- [More than ùëõ approximately orthonormal vectors in ùëÖùëõ](https://mathoverflow.net/questions/158575/more-than-n-approximately-orthonormal-vectors-in-rn)\nalso [here](https://mathoverflow.net/questions/24864/almost-orthogonal-vectors)\n\n- [Why does the surface area of the hypersphere go to zero as the number of dimensions goes to infinity?](https://math.stackexchange.com/questions/1382782/why-does-the-surface-area-of-the-hypersphere-go-to-zero-as-the-number-of-dimensi)\n\n- Spherical code [mathworld.wolfram.com](https://mathworld.wolfram.com/SphericalCode.html); \n[https://en.wikipedia.org/wiki/Spherical_code](https://en.wikipedia.org/wiki/Spherical_code); \n[https://en.wikipedia.org/wiki/Kissing_number](https://en.wikipedia.org/wiki/Kissing_number) \na lot of [examples](http://neilsloane.com/packings/)\n\n\n- SPHERE PACKING BOUNDS VIA SPHERICAL CODES by HENRY COHN AND YUFEI ZHAO [paper link](https://arxiv.org/pdf/1212.5966.pdf)\n\n",
    "supporting": [
      "index_files/figure-pdf"
    ],
    "filters": []
  }
}